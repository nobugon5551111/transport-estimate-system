<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦‹ç©ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨ä¿å­˜å•é¡Œã®ãƒ†ã‚¹ãƒˆ</h1>
        
        <div id="results" class="space-y-4"></div>
        
        <button id="testButton" class="btn-primary">ã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨ä¿å­˜ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
    </div>

    <script>
        // ãƒ†ã‚¹ãƒˆç”¨ã®è¦‹ç©ãƒ•ãƒ­ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        async function simulateEstimateFlow() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="text-blue-600">ğŸ§ª ãƒ†ã‚¹ãƒˆé–‹å§‹...</div>';
            
            try {
                // STEP1-3ã® ãƒ‡ãƒ¼ã‚¿ã‚’sessionStorageã«è¨­å®š
                const testFlowData = {
                    step: 4,
                    customer: { id: 1, name: 'ãƒ†ã‚¹ãƒˆé¡§å®¢' },
                    project: { id: 1, name: 'ãƒ†ã‚¹ãƒˆæ¡ˆä»¶' },
                    delivery: { address: 'ãƒ†ã‚¹ãƒˆä½æ‰€', postal_code: '1234567', area: 'A' },
                    vehicle: { type: '2tè»Š', operation: 'å¼•è¶Š', cost: 15000 }
                };
                
                sessionStorage.setItem('estimateFlow', JSON.stringify(testFlowData));
                results.innerHTML += '<div class="text-green-600">âœ… STEP1-3ãƒ‡ãƒ¼ã‚¿è¨­å®šå®Œäº†</div>';
                
                // STEP4ã®ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ‰‹å‹•ã§è¨­å®šï¼ˆproceedToStep5ã®å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                const staffInfo = {
                    supervisor_count: 1,
                    leader_count: 1, 
                    m2_staff_half_day: 2,
                    m2_staff_full_day: 1,
                    temp_staff_half_day: 0,
                    temp_staff_full_day: 0
                };
                
                // ã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨ã‚’è¨ˆç®—
                const rates = {
                    supervisor: 25000,
                    leader: 22000,
                    m2_half_day: 8500,
                    m2_full_day: 15000,
                    temp_half_day: 7500,
                    temp_full_day: 13500
                };
                
                const calculatedCost = 
                    (staffInfo.supervisor_count * rates.supervisor) +
                    (staffInfo.leader_count * rates.leader) +
                    (staffInfo.m2_staff_half_day * rates.m2_half_day) +
                    (staffInfo.m2_staff_full_day * rates.m2_full_day) +
                    (staffInfo.temp_staff_half_day * rates.temp_half_day) +
                    (staffInfo.temp_staff_full_day * rates.temp_full_day);
                
                console.log('ğŸ’° è¨ˆç®—ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨:', calculatedCost);
                results.innerHTML += `<div class="text-blue-600">ğŸ’° è¨ˆç®—ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨: Â¥${calculatedCost.toLocaleString()}</div>`;
                
                // å®Œå…¨ãªã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’ä½œæˆï¼ˆä¿®æ­£å¾Œã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                const completeStaffInfo = {
                    ...staffInfo,
                    total_cost: calculatedCost,
                    staff_cost: calculatedCost  // é‡è¦ï¼šä¸¡æ–¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
                };
                
                // STEP5ã¸ã®é€²è¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                testFlowData.step = 5;
                testFlowData.staff = completeStaffInfo;
                
                sessionStorage.setItem('estimateFlow', JSON.stringify(testFlowData));
                results.innerHTML += '<div class="text-green-600">âœ… STEP4â†’STEP5é€²è¡Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†</div>';
                
                // ä¿å­˜ç¢ºèª
                const savedData = JSON.parse(sessionStorage.getItem('estimateFlow') || '{}');
                console.log('ğŸ” ä¿å­˜ç¢ºèª:', savedData.staff);
                results.innerHTML += `<div class="text-blue-600">ğŸ” ä¿å­˜ã•ã‚ŒãŸtotal_cost: Â¥${(savedData.staff?.total_cost || 0).toLocaleString()}</div>`;
                results.innerHTML += `<div class="text-blue-600">ğŸ” ä¿å­˜ã•ã‚ŒãŸstaff_cost: Â¥${(savedData.staff?.staff_cost || 0).toLocaleString()}</div>`;
                
                // STEP6ã§ã®ã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨å–å¾—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                let staffCost = 0;
                if (savedData.staff.total_cost !== undefined && savedData.staff.total_cost !== null) {
                    staffCost = savedData.staff.total_cost;
                } else if (savedData.staff.staff_cost !== undefined && savedData.staff.staff_cost !== null) {
                    staffCost = savedData.staff.staff_cost;
                } else {
                    // æ‰‹å‹•å†è¨ˆç®—ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    staffCost = calculatedCost;
                    results.innerHTML += '<div class="text-red-600">âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç®—ã‚’ä½¿ç”¨</div>';
                }
                
                results.innerHTML += `<div class="text-green-600">âœ… STEP6ã§å–å¾—ã•ã‚Œã‚‹ã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨: Â¥${staffCost.toLocaleString()}</div>`;
                
                // è¦‹ç©ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆSTEP6ã®ä¿å­˜å‡¦ç†ï¼‰
                const estimateData = {
                    ...savedData.customer,
                    ...savedData.project,
                    ...savedData.delivery,
                    ...savedData.vehicle,
                    ...savedData.staff,
                    // ä¿®æ­£å¾Œã®staff_costè¨­å®šãƒ­ã‚¸ãƒƒã‚¯
                    staff_cost: savedData.staff.total_cost || 
                               savedData.staff.staff_cost || 
                               calculatedCost,
                    user_id: 'test-user'
                };
                
                console.log('ğŸ“¤ è¦‹ç©ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', estimateData);
                results.innerHTML += `<div class="text-green-600">âœ… è¦‹ç©ä¿å­˜æ™‚ã®staff_cost: Â¥${(estimateData.staff_cost || 0).toLocaleString()}</div>`;
                
                // APIã¸ã®é€ä¿¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã«ã¯é€ä¿¡ã›ãšã€ãƒ­ã‚°ã ã‘ï¼‰
                results.innerHTML += '<div class="text-green-600">âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ï¼šã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨ã®ä¿å­˜ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª</div>';
                
                if (estimateData.staff_cost > 0) {
                    results.innerHTML += '<div class="text-green-600 font-bold">ğŸ‰ ä¿®æ­£æˆåŠŸï¼šã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã¾ã™</div>';
                } else {
                    results.innerHTML += '<div class="text-red-600 font-bold">âŒ å•é¡Œç¶™ç¶šï¼šã‚¹ã‚¿ãƒƒãƒ•è²»ç”¨ãŒ0ã«ãªã£ã¦ã„ã¾ã™</div>';
                }
                
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                results.innerHTML += `<div class="text-red-600">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        document.getElementById('testButton').addEventListener('click', simulateEstimateFlow);
    </script>
</body>
</html>