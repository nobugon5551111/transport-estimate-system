# 🤖 AIエージェント運用ルール

## 📋 基本方針

このファイルは、AIエージェント（Claude）と開発者（ユーザー）間の運用ルール・約束事を定義します。

**作成日**: 2025-10-17  
**対象システム**: 輸送見積もりシステム  
**適用範囲**: 全開発・運用作業

---

## 🔒 GitHub運用ルール（最重要）

### ✅ 基本原則
```
🎯 ユーザー主導の保存管理
- GitHubへの保存はユーザーの明示的な指示後のみ実行
- 修正・開発中はローカル環境のみで作業
- 未完成・未承認の状態でのGitHub保存は禁止
```

### 📊 作業フロー
```
Phase 1: ローカル開発
├── AIがコード修正・機能追加
├── ローカルでテスト・動作確認  
├── 問題があれば修正・調整
└── 完成版をユーザーに報告

Phase 2: ユーザー確認
├── ユーザーが機能確認・テスト
├── 要望・修正指示（必要に応じて）
├── 最終承認・品質確認
└── 「GitHubに保存して」の明示的指示

Phase 3: GitHub保存実行
├── ユーザー指示後のみ実行
├── 適切なコミットメッセージ付き
├── 完成・承認済み版のみ記録
└── 将来の安定復元ポイントとして保存
```

### 🚫 禁止事項
- 勝手な判断でのGitHub保存
- 「とりあえず保存」の考え方
- 未完成版のGitHub記録
- ユーザー確認なしの自動保存

### ✅ 許可事項
- ローカルでの自由な開発・修正
- 完成版の動作テスト・品質確認
- ユーザーへの完成報告
- GitHub保存の提案（強制ではない）

---

## 🗣️ コミュニケーションルール

### 分かりやすい表現の使用
```
技術用語 → 分かりやすい表現
────────────────────────
プッシュ → 保存・送信・アップロード
コミット → 記録・保存
リポジトリ → プロジェクト保管庫
ブランチ → 作業用コピー
マージ → 統合・結合
```

### 推奨会話パターン
```
✅ 作業完了時
「○○の修正が完了しました。動作確認をお願いします」
「問題なければ、GitHubへの保存をご指示ください」

✅ 提案時
「この改修内容をGitHubに保存することをお勧めします」
「安全のため、GitHubにバックアップしませんか？」

❌ 避ける表現
「プッシュします」
「とりあえず保存しておきます」
「勝手に判断して保存します」
```

---

## ⚙️ 開発・修正ルール

### 基本開発方針
```
🎯 品質第一
- 完成まではローカルで完璧に仕上げる
- テスト・動作確認を徹底
- エラーハンドリングの実装
- ユーザビリティの考慮

🔧 技術方針  
- Hono + TypeScript + Cloudflare Workers
- PM2でのプロセス管理
- 300秒以上のタイムアウト設定（npm系コマンド）
- モジュラー設計・拡張性重視
```

### コード品質基準
```
✅ 必須事項
- エラーハンドリングの実装
- 適切なログ出力
- コメント・ドキュメント
- 一貫したコーディングスタイル

✅ 動作確認項目
- ローカルビルド成功
- PM2での起動成功
- 基本機能の動作テスト
- エラーケースの確認
```

---

## 📊 プロジェクト管理ルール

### ファイル管理
```
📁 重要ディレクトリ
/home/user/webapp/ - プロジェクトルート
├── src/ - ソースコード
├── public/static/ - 静的ファイル  
├── dist/ - ビルド済みファイル
├── migrations/ - データベース変更
└── docs/ - ドキュメント類

📄 重要ファイル
- AGENT.md - 本ファイル（運用ルール）
- README.md - プロジェクト説明書
- package.json - 依存関係定義
- wrangler.jsonc - Cloudflare設定
```

### バックアップ戦略
```
🔄 多層バックアップ
1. ローカルファイル（即座復元用）
2. Git履歴（バージョン管理）
3. GitHub Actions（自動化）
4. GenSpark CDN（オフライン保管）
```

---

## 🛡️ 完成機能保護ルール（最重要）

### ✅ 完成機能の定義と保護対象
```
完成機能 = 以下の条件を満たした機能（絶対に壊してはいけない）:
1. ユーザーから「修正完了」の確認を得た機能
2. 動作テストを通過し、承認された機能
3. GitHubに保存済みの安定版機能
4. 本番運用中で問題なく稼働している機能

現在の保護対象機能:
✅ Step1-6: 全見積作成フロー
✅ マスターデータAPI連携機能  
✅ 動的ラベル更新機能（Step4/Step5）
✅ 養生作業フロア計算機能（Step5）
✅ PDF出力機能・データベース構造
```

### 🔒 修正作業時の必須手順
```
Step 1: 影響範囲分析（必須）
├── 修正対象機能の特定
├── 完成機能への影響「あり/なし」判定
├── 依存関係・データベース変更の影響確認
└── バックアップ・ロールバック手順準備

Step 2: 保護実装戦略（必須）
├── 新機能は独立したファイル・関数で実装
├── 既存コードの変更は最小限に限定
├── 完成機能との結合は最終段階で実施
└── 各段階でのテスト実行

Step 3: 完成機能保護テスト（必須）
├── 修正後に全完成機能の動作確認
├── データ整合性・API レスポンス確認
├── UI動作・計算結果の正確性確認
└── エラーケース・例外処理確認
```

### 🚫 絶対禁止事項
```
❌ 完成機能への無計画な変更
❌ データベーススキーマの破壊的変更
❌ APIエンドポイント・レスポンス形式変更
❌ 既存機能のHTML要素ID変更
❌ sessionStorageキー名の変更
❌ 複数機能の同時大幅変更
```

---

## 🧹 開発負債管理ルール

### 📊 開発負債の分類・優先順位
```
🔴 Critical（即座対応必要）
- セキュリティ脆弱性・データ損失リスク
- システム停止要因・重大パフォーマンス問題

🟡 Major（計画的対応必要）  
- 重複コード・ファイル・未使用ライブラリ
- 不適切な設計パターン・ドキュメント不備

🟢 Minor（余裕がある時対応）
- コードスタイル統一・変数名改善
- コメント追加・リファクタリング機会
```

### 🛡️ 負債整理の安全手順
```
Phase 1: 負債棚卸し・影響分析
├── 全負債のレベル分類・優先順位付け
├── 完成機能への影響範囲分析
├── 整理計画策定・スケジュール決定
└── バックアップ・復旧手順準備

Phase 2: 段階的安全整理
├── 一つずつ段階的に整理（複数同時禁止）
├── 完成機能に影響しない負債から着手
├── 整理後は必ず全機能テスト実行
└── 問題発生時は即座にロールバック

Phase 3: 整理結果検証・記録
├── システム全体動作確認・効果測定
├── 整理内容の詳細文書化
└── 次回整理計画への反映・改善
```

---

## 🚨 緊急時対応ルール

### 🔴 完成機能破損時の緊急対応
```
Step 1: 即座停止・現状保持
├── 作業を即座に中断・現状をローカル保持
├── 破損範囲・原因の特定
└── ユーザーへの緊急報告・状況説明

Step 2: 復旧方法検討・実行
├── バックアップからの部分復元
├── Git履歴からの特定ファイル復元
├── 手動コード修正・データベース部分ロールバック
└── 復旧手順の慎重実行

Step 3: 復旧後検証・再発防止
├── 全機能動作確認・データ整合性確認
├── 破損原因の根本分析・記録
└── 再発防止策実装・ルール見直し
```

### 🟡 その他問題の対応優先順位
```
🔴 Priority 1: 即座対応
- 完成機能への影響・システム停止
- セキュリティ問題・データ損失リスク

🟡 Priority 2: 計画対応  
- 新機能改善・追加・パフォーマンス最適化
- UI/UX改善・開発負債整理
```

### 例外的GitHub保存
```
以下の場合のみ、GitHub保存を強く提案可能：
1. 重大バグ修正完了時
2. 長時間（3時間以上）作業完了時
3. 作業セッション終了前
4. システム停止回避のため

※ただし最終判断はユーザーに委ねる
```

---

## 🎯 品質管理基準

### コード品質・完成機能保護
```
✅ 修正前必須確認項目
- [ ] 影響範囲分析完了（完成機能への影響確認）
- [ ] バックアップ作成完了（ローカル + GitHub状態確認）
- [ ] 修正計画策定完了（段階的実装手順決定）
- [ ] テスト項目リスト作成完了
- [ ] ロールバック手順準備完了

✅ 実装中必須チェック項目
- [ ] エラーハンドリング実装済み
- [ ] 適切なログ出力設定
- [ ] TypeScript型安全性確保
- [ ] 既存機能のHTML要素ID変更なし
- [ ] APIエンドポイント・レスポンス形式変更なし

✅ 修正後必須確認項目  
- [ ] npm run build 成功
- [ ] PM2起動成功（pm2 start ecosystem.config.cjs）
- [ ] curl http://localhost:3000 応答確認
- [ ] 全完成機能の動作テスト（Step1-6全て）
- [ ] マスターデータAPI応答確認
- [ ] 動的ラベル更新機能確認
- [ ] 養生作業フロア計算機能確認
- [ ] PDF出力機能確認
- [ ] データベース整合性確認
- [ ] エラーケース・例外処理確認
```

### ユーザビリティ
```
🎨 UI/UX基準
- 直感的な操作性
- 一貫したデザイン
- 適切なエラーメッセージ
- レスポンシブ対応
- アクセシビリティ配慮
```

---

## 📋 定期確認事項

### 日常確認（作業開始時）
```
1. PM2サービス状態確認（pm2 list）
2. ポート3000の使用状況確認
3. 最新ファイル同期確認
4. ローカルビルド可能性確認
```

### 週次確認
```  
1. Dependencies脆弱性確認（npm audit）
2. 不要ファイルクリーンアップ
3. ログファイル整理
4. バックアップ整合性確認
```

### 月次確認
```
1. 全機能動作テスト
2. パフォーマンス測定
3. セキュリティ監査
4. ドキュメント更新
```

---

## 🔧 技術仕様・制約事項

### Cloudflare Workers制約
```
🚫 使用不可機能
- Node.js専用API（fs, child_process等）
- ローカルファイルシステム操作
- 長時間実行プロセス
- WebSocketサーバー

✅ 推奨代替手段
- Web標準API使用
- Cloudflare D1データベース
- 外部API連携（REST）
- サーバーレス設計
```

### 開発環境制約
```
⚙️ PM2使用必須
- 直接的なnpmスクリプト実行禁止
- 必ずPM2経由でサービス管理
- ecosystem.config.cjs設定必須

⏱️ タイムアウト設定
- npm系コマンド: 300秒以上
- ビルド処理: 300秒以上
- API呼び出し: 120秒以内
```

---

## 📞 トラブルシューティング

### 一般的な問題と対処
```
🔧 ビルドエラー
1. node_modules削除 → npm install
2. distディレクトリ削除 → npm run build
3. PM2プロセスリセット → pm2 delete all

🔧 ポート競合
1. fuser -k 3000/tcp
2. pm2 delete all  
3. プロセス強制終了後再起動

🔧 認証エラー
1. setup_github_environment実行
2. 認証情報再設定
3. リモートURL確認
```

---

## 📈 継続改善

### 定期見直し事項
```
📋 月次見直し
- 運用ルールの有効性確認
- 新しい技術・手法の検討
- ユーザーフィードバック反映
- 効率化・自動化の改善

📋 四半期見直し
- 全体アーキテクチャ見直し
- セキュリティ基準更新
- パフォーマンス基準見直し
- ドキュメント全体更新
```

### 改善提案プロセス
```
1. 問題・改善点の特定
2. 解決案の検討・提案
3. ユーザーとの協議・決定
4. AGENT.mdファイル更新
5. 新ルール適用開始
```

---

## ✅ 承認・更新履歴

### Version 1.0 - 2025-10-17
```
👤 作成者: Claude (AIエージェント)
📋 承認者: ユーザー（承認待ち）
📅 作成日: 2025-10-17 06:16:14
🎯 対象: 輸送見積もりシステム開発・運用

📝 初期ルール策定内容:
- GitHub運用ルール（ユーザー主導保存）
- コミュニケーションルール（分かりやすい表現）
- 開発・修正ルール（品質第一）
- 緊急時対応ルール（例外規定）
```

### 更新予定
```
🔄 このファイルは以下のタイミングで更新されます:
- 新しい運用ルール追加時
- 既存ルール変更時  
- 問題発生・改善時
- 技術仕様変更時

※更新は必ずユーザー承認後に実施
```

---

**このAGENT.mdファイルに記載されたルールは、AIエージェント（Claude）が厳格に遵守する運用基準です。**