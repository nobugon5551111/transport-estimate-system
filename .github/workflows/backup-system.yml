name: ğŸ”„ System Backup & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJST 12æ™‚ï¼‰ã«è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Backup Type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - code-only
          - database-only

jobs:
  backup:
    name: ğŸ“¦ Create System Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“… Set Timestamp
        id: timestamp
        run: |
          echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "human_date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build Project
        run: npm run build
      
      - name: ğŸ“Š System Information
        id: sysinfo
        run: |
          echo "node_version=$(node --version)" >> $GITHUB_OUTPUT
          echo "npm_version=$(npm --version)" >> $GITHUB_OUTPUT
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch_name=$(git branch --show-current)" >> $GITHUB_OUTPUT
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚«ã‚¦ãƒ³ãƒˆ
          echo "total_files=$(find . -type f | wc -l)" >> $GITHUB_OUTPUT
          echo "js_files=$(find . -name '*.js' -o -name '*.ts' -o -name '*.tsx' | wc -l)" >> $GITHUB_OUTPUT
      
      - name: ğŸ“‹ Create Backup Manifest
        run: |
          cat > BACKUP_MANIFEST_${{ steps.timestamp.outputs.date }}.md << 'EOF'
          # ğŸ”„ Automated System Backup
          
          ## ğŸ“… Backup Information
          - **Date**: ${{ steps.timestamp.outputs.human_date }}
          - **Trigger**: ${{ github.event_name }}
          - **Branch**: ${{ steps.sysinfo.outputs.branch_name }}
          - **Commit**: ${{ steps.sysinfo.outputs.commit_hash }}
          
          ## ğŸ“Š System Details
          - **Node.js**: ${{ steps.sysinfo.outputs.node_version }}
          - **npm**: ${{ steps.sysinfo.outputs.npm_version }}
          - **Total Files**: ${{ steps.sysinfo.outputs.total_files }}
          - **JS/TS Files**: ${{ steps.sysinfo.outputs.js_files }}
          
          ## ğŸ—‚ï¸ Backup Contents
          - âœ… Source code (src/, public/)
          - âœ… Configuration files
          - âœ… Documentation
          - âœ… Build artifacts (dist/)
          - âœ… Database schemas
          
          ## ğŸ“¦ Archive Information
          - **Size**: $(du -sh . | cut -f1)
          - **Compression**: tar.gz
          - **Integrity**: SHA256 checksum included
          
          EOF
      
      - name: ğŸ—œï¸ Create Archive
        run: |
          # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='*.tar.gz' \
              --exclude='.wrangler' \
              -czf system_backup_${{ steps.timestamp.outputs.date }}.tar.gz \
              .
          
          # ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆ
          sha256sum system_backup_${{ steps.timestamp.outputs.date }}.tar.gz > system_backup_${{ steps.timestamp.outputs.date }}.sha256
      
      - name: ğŸ“¤ Upload Backup Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: system-backup-${{ steps.timestamp.outputs.date }}
          path: |
            system_backup_${{ steps.timestamp.outputs.date }}.tar.gz
            system_backup_${{ steps.timestamp.outputs.date }}.sha256
            BACKUP_MANIFEST_${{ steps.timestamp.outputs.date }}.md
          retention-days: 90
      
      # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
      - name: ğŸ·ï¸ Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ğŸš€ Release ${{ github.ref_name }}
          body: |
            ## ğŸ“‹ System Backup Release
            
            **Date**: ${{ steps.timestamp.outputs.human_date }}
            **Commit**: ${{ steps.sysinfo.outputs.commit_hash }}
            
            ### âœ… Contents
            - Complete source code
            - Configuration files
            - Build artifacts
            - Documentation
            - Database schemas
            
            ### ğŸ“¦ Download
            - [System Backup Archive](system_backup_${{ steps.timestamp.outputs.date }}.tar.gz)
            - [SHA256 Checksum](system_backup_${{ steps.timestamp.outputs.date }}.sha256)
            
            ### ğŸ”„ Restoration
            See `COMPLETE_RESTORATION_GUIDE_*.md` for detailed instructions.
          draft: false
          prerelease: false

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å°‚ç”¨ã‚¸ãƒ§ãƒ–
  database-backup:
    name: ğŸ—ƒï¸ Database Backup
    runs-on: ubuntu-latest
    if: github.event.inputs.backup_type == 'full' || github.event.inputs.backup_type == 'database-only' || github.event_name == 'schedule'
    
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“… Set Timestamp
        id: timestamp
        run: echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: ğŸ”§ Setup Wrangler
        run: npm install -g wrangler
      
      # æ³¨æ„: å®Ÿéš›ã®æœ¬ç•ªç’°å¢ƒã§ã¯èªè¨¼æƒ…å ±ãŒå¿…è¦
      - name: ğŸ“Š Database Schema Export
        run: |
          echo "-- Database Schema Export $(date)" > database_schema_${{ steps.timestamp.outputs.date }}.sql
          echo "-- Generated by GitHub Actions" >> database_schema_${{ steps.timestamp.outputs.date }}.sql
          echo "-- Repository: ${{ github.repository }}" >> database_schema_${{ steps.timestamp.outputs.date }}.sql
          echo "-- Commit: ${{ github.sha }}" >> database_schema_${{ steps.timestamp.outputs.date }}.sql
          echo "" >> database_schema_${{ steps.timestamp.outputs.date }}.sql
          
          # ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚³ãƒ”ãƒ¼
          if [ -f "migrations/0001_initial_schema.sql" ]; then
            cat migrations/*.sql >> database_schema_${{ steps.timestamp.outputs.date }}.sql
          fi
      
      - name: ğŸ“¤ Upload Database Backup
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ steps.timestamp.outputs.date }}
          path: database_schema_${{ steps.timestamp.outputs.date }}.sql
          retention-days: 180

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-check:
    name: ğŸ”’ Security & Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ” Audit Dependencies
        run: |
          npm audit --audit-level moderate || true
          npm audit --json > security_audit_$(date +'%Y%m%d_%H%M%S').json || true
      
      - name: ğŸ“Š Code Quality Check
        run: |
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          find . -name "*.js" -size +1M -exec ls -lh {} \; || true
          
          # é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          find . -name "*.js" -exec basename {} \; | sort | uniq -d || true
      
      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-$(date +'%Y%m%d_%H%M%S')
          path: security_audit_*.json
          retention-days: 30